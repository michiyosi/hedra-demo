<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LiveKit æ˜ åƒãƒ»éŸ³å£°ãƒ‡ãƒ¢ï¼ˆæœ€å°ï¼‰</title>
  <style>
    body{font-family:system-ui,Segoe UI,Noto Sans JP,Meiryo,sans-serif;margin:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    video{width:48%;max-width:520px;background:#111;border-radius:10px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;cursor:pointer}
    #status{margin-left:8px;color:#666}
  </style>
</head>
<body>
  <h1>LiveKit æ˜ åƒãƒ»éŸ³å£°ãƒ‡ãƒ¢ï¼ˆæœ€å°ï¼‰</h1>

  <div class="row">
    <input id="name" placeholder="è¡¨ç¤ºåï¼ˆä¾‹: Guest Aï¼‰" style="padding:10px;border-radius:10px;border:1px solid #ccc" />
    <button id="joinBtn">ğŸ”Œ æ¥ç¶š</button>
    <button id="leaveBtn" disabled>â¹ åˆ‡æ–­</button>
    <span id="status">æœªæ¥ç¶š</span>
  </div>

  <div class="row">
    <div style="flex:1;min-width:300px">
      <h3>è‡ªåˆ†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</h3>
      <video id="localVideo" autoplay muted playsinline></video>
    </div>
    <div style="flex:1;min-width:300px">
      <h3>ç›¸æ‰‹ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆï¼‰</h3>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

  <!-- UMD ç‰ˆ LiveKit ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ -->
  <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    const setStatus = (t)=>{$("status").textContent=t};
    let room = null;
    let localCamTrack = null;
    let localMicTrack = null;
    const remoteAudioEls = [];

    async function getTokenAndUrl() {
      const name = $("name").value || "Guest";
      // åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸Šã® /api/getToken ã‚’å©ãï¼ˆVercelã«é…ç½®æ¸ˆã¿ï¼‰
      const res = await fetch(`/api/getToken?name=${encodeURIComponent(name)}&room=demo-room`);
      if (!res.ok) throw new Error(`getToken å¤±æ•—: HTTP ${res.status}`);
      const data = await res.json();
      if (!data?.token || !data?.url) throw new Error("getToken å¿œç­”ã« token/url ãŒã‚ã‚Šã¾ã›ã‚“");
      return data; // { token, url, room }
    }

    async function join() {
      try {
        $("joinBtn").disabled = true; setStatus("ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ä¸­â€¦");
        const { token, url } = await getTokenAndUrl();

        // 1) ãƒ«ãƒ¼ãƒ ä½œæˆï¼†æ¥ç¶šï¼ˆUMDã§ã¯ new LivekitClient.Room().connect(...)ï¼‰
        setStatus("LiveKitã«æ¥ç¶šä¸­â€¦");
        room = new LivekitClient.Room();
        await room.connect(url, token);
        setStatus("æ¥ç¶šå®Œäº†ã€‚ã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯å–å¾—ä¸­â€¦ï¼ˆè¨±å¯ã—ã¦ãã ã•ã„ï¼‰");

        // 2) ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ©ãƒƒã‚¯ï¼ˆã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯ï¼‰ã‚’ä½œæˆï¼†å…¬é–‹
        const { createLocalVideoTrack, createLocalAudioTrack } = LivekitClient;
        localCamTrack = await createLocalVideoTrack();
        localMicTrack = await createLocalAudioTrack();

        await room.localParticipant.publishTrack(localCamTrack);
        await room.localParticipant.publishTrack(localMicTrack);

        // ãƒ­ãƒ¼ã‚«ãƒ«æ˜ åƒã‚’è¡¨ç¤º
        const localEl = localCamTrack.attach();
        localEl.muted = true; // è‡ªåˆ†ã®éŸ³ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆãƒã‚¦ãƒªãƒ³ã‚°é˜²æ­¢ï¼‰
        $("localVideo").replaceWith(localEl);
        localEl.id = "localVideo";
        localEl.playsInline = true;
        try { await localEl.play(); } catch {}

        // 3) ãƒªãƒ¢ãƒ¼ãƒˆãƒˆãƒ©ãƒƒã‚¯ã®å—ä¿¡
        room.on("trackSubscribed", (track, pub, participant) => {
          if (track.kind === "video") {
            const el = track.attach();
            el.playsInline = true;
            $("remoteVideo").replaceWith(el);
            el.id = "remoteVideo";
            // iOS å¯¾ç­–
            el.addEventListener('loadedmetadata', ()=>{ el.muted = false; el.play().catch(()=>{}); });
          }
          if (track.kind === "audio") {
            const el = track.attach(); // audioè¦ç´ 
            document.body.appendChild(el); // ç”»é¢ã«å‡ºã•ãªãã¦ã‚‚OKï¼ˆappendã ã‘ã§å†ç”Ÿï¼‰
            remoteAudioEls.push(el);
            try { el.play(); } catch {}
          }
        });

        room.on("disconnected", () => {
          setStatus("åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
          $("leaveBtn").disabled = true;
          $("joinBtn").disabled = false;
        });

        $("leaveBtn").disabled = false;
        setStatus("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆdemo-roomï¼‰");
      } catch (e) {
        console.error(e);
        setStatus("ã‚¨ãƒ©ãƒ¼: " + (e?.message || e));
        $("joinBtn").disabled = false;
        alert("æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + (e?.message || e));
      }
    }

    async function leave() {
      try {
        if (localCamTrack) { localCamTrack.stop(); localCamTrack = null; }
        if (localMicTrack) { localMicTrack.stop(); localMicTrack = null; }
        if (room) { await room.disconnect(); room = null; }
      } finally {
        $("leaveBtn").disabled = true;
        $("joinBtn").disabled = false;
        setStatus("æœªæ¥ç¶š");
        // videoã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        const lv = document.createElement('video');
        lv.id = 'localVideo'; lv.autoplay = true; lv.muted = true; lv.playsInline = true;
        const rv = document.createElement('video');
        rv.id = 'remoteVideo'; rv.autoplay = true; rv.playsInline = true;
        $("localVideo")?.replaceWith(lv);
        $("remoteVideo")?.replaceWith(rv);
        // remove remote audio elements
        remoteAudioEls.forEach(el=>el.remove());
        remoteAudioEls.length = 0;
      }
    }

    $("joinBtn").onclick = join;
    $("leaveBtn").onclick = leave;
  </script>
</body>
</html>
