<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>広島観光案内AIエージェント 体験リンク（デモ仕上げ版）</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0a0f23; --bg2:#0c1433; --card:#0f1a3b; --ink:#e9efff; --muted:#a7b0c8;
      --line:rgba(255,255,255,.08); --accent:#72a7ff; --accent2:#7affd5;
      --ok:#25d366; --warn:#ffd166; --err:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Noto Sans JP",Meiryo,sans-serif;
      background:
        radial-gradient(1200px 600px at 15% -10%, #1b2750 0%, transparent 60%),
        radial-gradient(1000px 600px at 100% 0%, #142351 0%, transparent 50%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    }
    .wrap{max-width:1080px; margin:36px auto 48px; padding:0 20px}
    header{display:flex; gap:12px; align-items:center; margin:0 0 16px}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2)); box-shadow:0 8px 24px rgba(122,255,213,.25)}
    h1{font-size:28px;margin:0}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--line);font-size:13px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(15,26,59,.75); border:1px solid var(--line); backdrop-filter:blur(6px); border-radius:18px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    label{display:block;color:var(--muted);font-size:13px;margin:2px 0 6px}
    input{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#0d1533;color:var(--ink)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    /* 映像パネル */
    .video{
      position:relative;height:380px;border:1px solid var(--line);border-radius:16px;overflow:hidden;
      background:linear-gradient(180deg,#0b122b,#0d1736);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    /* 走査線 */
    .scan{position:absolute;inset:0;background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.04) 0 2px, transparent 2px 6px);
      animation:scan 7s linear infinite;}
    @keyframes scan{from{transform:translateY(-60px)} to{transform:translateY(60px)}}
    /* シャイン */
    .shine{position:absolute;inset:-40% -10% auto -10%;height:40%;background:
      linear-gradient(120deg, transparent 0%, rgba(255,255,255,.12) 35%, transparent 70%);transform:rotate(-5deg);filter:blur(10px);animation:shine 5s ease-in-out infinite}
    @keyframes shine{0%{transform:translateX(-40%) rotate(-5deg)} 100%{transform:translateX(40%) rotate(-5deg)}}
    /* 右上: ステータス */
    .badge{position:absolute;top:12px;left:12px;display:flex;gap:10px;align-items:center;background:rgba(8,12,28,.7);
      border:1px solid var(--line);backdrop-filter:blur(6px);padding:8px 12px;border-radius:999px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 0 rgba(255,209,102,.6);animation:pulse 1.4s ease-in-out infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,209,102,.6)}70%{box-shadow:0 0 0 12px rgba(255,209,102,0)}100%{box-shadow:0 0 0 0 rgba(255,209,102,0)}}
    /* 中央テキスト */
    .center{position:absolute;inset:0;display:grid;place-items:center;text-align:center;color:#cfe1ff}
    .center small{display:block;color:var(--muted)}
    /* マイクレベル風 */
    .meters{position:absolute;left:12px;bottom:12px;display:flex;gap:6px}
    .bar{width:4px;height:18px;border-radius:999px;background:rgba(255,255,255,.18);animation:level 1s ease-in-out infinite alternate}
    .bar:nth-child(2){animation-delay:.15s}
    .bar:nth-child(3){animation-delay:.3s}
    .bar:nth-child(4){animation-delay:.45s}
    .bar:nth-child(5){animation-delay:.6s}
    @keyframes level{from{height:6px} to{height:26px}}
    /* ボタン */
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    button{appearance:none;cursor:pointer;padding:11px 14px;border-radius:12px;border:1px solid var(--line);background:#0d1533;color:var(--ink);font-weight:600}
    .primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#081024;border:none;box-shadow:0 10px 20px rgba(114,167,255,.25)}
    .ghost{background:transparent}
    .danger{border-color:rgba(255,107,107,.4);color:#ffc7c7}
    .status{margin-top:10px;color:var(--muted);font-size:13px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
    footer{opacity:.75;font-size:13px;margin-top:20px;line-height:1.6}
    .hint{color:var(--muted)}
    .kicker{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <h1>Hedra Live Avatars 体験リンク <span class="pill">デモ仕上げ版</span></h1>
    </header>

    <div class="grid">
      <!-- 左パネル：映像＆操作 -->
      <section class="card" aria-label="映像パネル">
        <div class="video" id="videoBox" role="img" aria-label="アバター映像（デモ）">
          <div class="shine" aria-hidden="true"></div>
          <div class="scan" aria-hidden="true"></div>
          <div class="badge"><span class="dot" id="dot"></span><span id="badge">待機中</span></div>
          <div class="center" id="center">
            <div>
              <div style="font-size:18px;font-weight:700">ここにアバター映像が表示されます</div>
              <small>現在はデモ表示です。のちほど LiveKit に接続します。</small>
            </div>
          </div>
          <div class="meters" aria-hidden="true">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
          </div>
        </div>

        <div class="controls">
          <button class="primary" id="btnConnect">🔌 接続する（デモ）</button>
          <button class="ghost" id="btnMic">🎤 マイク許可（デモ）</button>
          <button class="ghost" id="btnReset">🔄 リセット</button>
          <button class="danger" id="btnEnd">⏹ 切断（デモ）</button>
        </div>
        <div id="status" class="status">状態：未接続</div>
        <div class="kicker">ヒント：後で <code>/api/getToken</code> を呼び出し、<code>livekit-client</code> で本接続に切り替えます。</div>
      </section>

      <!-- 右パネル：設定 -->
      <aside class="card" aria-label="設定">
        <div style="margin-bottom:14px">
          <label for="name">表示名</label>
          <input id="name" placeholder="例：Guest A" autocomplete="name">
        </div>

        <div class="row" style="margin-bottom:12px">
          <div>
            <label>音声</label>
            <span class="pill">日本語 / 自動</span>
          </div>
          <div>
            <label>表情</label>
            <span class="pill">標準（デモ）</span>
          </div>
        </div>

        <footer>
          <p class="hint">このページは <strong>ダミーUI</strong> です。見た目と操作感を確認するためのもの。後で LiveKit と Hedra を結線して実動化します。</p>
        </footer>
      </aside>
    </div>
  </div>

  <!-- LiveKit クライアント読込（追加） -->
<script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>

<!-- 接続ロジック（差し替え） -->
<script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
<script>
  const $ = (id)=>document.getElementById(id);
  const setStatus = (m,c="")=>{ const el=$("status"); el.textContent="状態："+m; el.className="status "+c; };
  const setBadge = (t,color)=>{ $("badge").textContent=t; $("dot").style.background=color; };

  async function publishLocalTracks(room){
    const { LocalVideoTrack, LocalAudioTrack } = LivekitClient;
    const cam = await LocalVideoTrack.create();   // ← ここで権限ダイアログが出ます
    const mic = await LocalAudioTrack.create();
    await room.localParticipant.publishTrack(cam);
    await room.localParticipant.publishTrack(mic);
    const el = cam.attach();
    Object.assign(el.style,{width:"100%",height:"100%",objectFit:"cover"});
    $("center").style.opacity=.2; $("videoBox").appendChild(el);
  }
  function wireRemoteTracks(room){
    room.on("trackSubscribed",(track)=>{
      if(track.kind==="video"){
        const el=track.attach();
        Object.assign(el.style,{width:"100%",height:"100%",objectFit:"cover"});
        $("videoBox").appendChild(el);
      }
    });
  }

  let roomRef=null;

  $("btnConnect").onclick = async ()=>{
    const name = $("name").value || "Guest";
    try{
      // ① getToken
      setStatus("トークン取得中…"); setBadge("接続準備","#ffd166");
      const res = await fetch(`/api/getToken?name=${encodeURIComponent(name)}&room=demo-room`);
      const raw = await res.text();
      if(!res.ok) throw new Error(`getToken HTTP ${res.status}: ${raw}`);
      let data; try{ data = JSON.parse(raw); }catch{ throw new Error(`getToken JSON解析失敗: ${raw}`); }
      if(!data?.token || !data?.url) throw new Error(`getToken 応答が不正: ${raw}`);

      // ② LiveKit接続
      setStatus("LiveKitへ接続中…");
      const room = await LivekitClient.connect(data.url, data.token);
      roomRef = room; wireRemoteTracks(room);

      // ③ カメラ/マイク
      setStatus("カメラ/マイク取得中…（許可してください）");
      await publishLocalTracks(room);

      setStatus("オンライン（接続中）","ok"); setBadge("オンライン","#25d366");
    }catch(e){
      console.error(e);
      setStatus(String(e.message||e),"err");
      alert(String(e.message||e));   // ← 具体的な原因が出ます
    }
  };

  $("btnMic").onclick = async ()=>{ setStatus("マイク権限を確認"); await new Promise(r=>setTimeout(r,300)); setStatus("マイク OK","ok"); };
  $("btnReset").onclick = ()=>{ try{roomRef?.disconnect();}catch{} location.reload(); };
</script>


</body>
</html>
