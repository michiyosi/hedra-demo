<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LiveKit 映像・音声デモ（最小）</title>
  <style>
    body{font-family:system-ui,Segoe UI,Noto Sans JP,Meiryo,sans-serif;margin:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    video{width:48%;max-width:520px;background:#111;border-radius:10px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;cursor:pointer}
    #status{margin-left:8px;color:#666}
  </style>
</head>
<body>
  <h1>LiveKit 映像・音声デモ（最小）</h1>

  <div class="row">
    <input id="name" placeholder="表示名（例: Guest A）" style="padding:10px;border-radius:10px;border:1px solid #ccc" />
    <button id="joinBtn">🔌 接続</button>
    <button id="leaveBtn" disabled>⏹ 切断</button>
    <span id="status">未接続</span>
  </div>

  <div class="row">
    <div style="flex:1;min-width:300px">
      <h3>自分（ローカル）</h3>
      <video id="localVideo" autoplay muted playsinline></video>
    </div>
    <div style="flex:1;min-width:300px">
      <h3>相手（リモート）</h3>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

  <!-- UMD 版 LiveKit クライアント -->
  <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    const setStatus = (t)=>{$("status").textContent=t};
    let room = null;
    let localCamTrack = null;
    let localMicTrack = null;
    const remoteAudioEls = [];

    async function getTokenAndUrl() {
      const name = $("name").value || "Guest";
      // 同じドメイン上の /api/getToken を叩く（Vercelに配置済み）
      const res = await fetch(`/api/getToken?name=${encodeURIComponent(name)}&room=demo-room`);
      if (!res.ok) throw new Error(`getToken 失敗: HTTP ${res.status}`);
      const data = await res.json();
      if (!data?.token || !data?.url) throw new Error("getToken 応答に token/url がありません");
      return data; // { token, url, room }
    }

    async function join() {
      try {
        $("joinBtn").disabled = true; setStatus("トークン取得中…");
        const { token, url } = await getTokenAndUrl();

        // 1) ルーム作成＆接続（UMDでは new LivekitClient.Room().connect(...)）
        setStatus("LiveKitに接続中…");
        room = new LivekitClient.Room();
        await room.connect(url, token);
        setStatus("接続完了。カメラ/マイク取得中…（許可してください）");

        // 2) ローカルトラック（カメラ/マイク）を作成＆公開
        const { createLocalVideoTrack, createLocalAudioTrack } = LivekitClient;
        localCamTrack = await createLocalVideoTrack();
        localMicTrack = await createLocalAudioTrack();

        await room.localParticipant.publishTrack(localCamTrack);
        await room.localParticipant.publishTrack(localMicTrack);

        // ローカル映像を表示
        const localEl = localCamTrack.attach();
        localEl.muted = true; // 自分の音をミュート（ハウリング防止）
        $("localVideo").replaceWith(localEl);
        localEl.id = "localVideo";
        localEl.playsInline = true;
        try { await localEl.play(); } catch {}

        // 3) リモートトラックの受信
        room.on("trackSubscribed", (track, pub, participant) => {
          if (track.kind === "video") {
            const el = track.attach();
            el.playsInline = true;
            $("remoteVideo").replaceWith(el);
            el.id = "remoteVideo";
            // iOS 対策
            el.addEventListener('loadedmetadata', ()=>{ el.muted = false; el.play().catch(()=>{}); });
          }
          if (track.kind === "audio") {
            const el = track.attach(); // audio要素
            document.body.appendChild(el); // 画面に出さなくてもOK（appendだけで再生）
            remoteAudioEls.push(el);
            try { el.play(); } catch {}
          }
        });

        room.on("disconnected", () => {
          setStatus("切断されました");
          $("leaveBtn").disabled = true;
          $("joinBtn").disabled = false;
        });

        $("leaveBtn").disabled = false;
        setStatus("オンライン（demo-room）");
      } catch (e) {
        console.error(e);
        setStatus("エラー: " + (e?.message || e));
        $("joinBtn").disabled = false;
        alert("接続に失敗しました。\n" + (e?.message || e));
      }
    }

    async function leave() {
      try {
        if (localCamTrack) { localCamTrack.stop(); localCamTrack = null; }
        if (localMicTrack) { localMicTrack.stop(); localMicTrack = null; }
        if (room) { await room.disconnect(); room = null; }
      } finally {
        $("leaveBtn").disabled = true;
        $("joinBtn").disabled = false;
        setStatus("未接続");
        // videoを初期状態に戻す
        const lv = document.createElement('video');
        lv.id = 'localVideo'; lv.autoplay = true; lv.muted = true; lv.playsInline = true;
        const rv = document.createElement('video');
        rv.id = 'remoteVideo'; rv.autoplay = true; rv.playsInline = true;
        $("localVideo")?.replaceWith(lv);
        $("remoteVideo")?.replaceWith(rv);
        // remove remote audio elements
        remoteAudioEls.forEach(el=>el.remove());
        remoteAudioEls.length = 0;
      }
    }

    $("joinBtn").onclick = join;
    $("leaveBtn").onclick = leave;
  </script>
</body>
</html>
